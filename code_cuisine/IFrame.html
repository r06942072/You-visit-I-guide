<html>

<head>
    <style>
        #map {
            height: 500px;
            width: 100%;
        }
    </style>
</head>

<body onLoad="init()">
    <div id="map"></div>
    <script>
        function init() {
            //execute window.onmessage when receive message from page code (postMessage)
            window.onmessage = (event) => {
                if (event.data) {
                    let datas = event.data.Arr;
                    var map = new google.maps.Map(
                        document.getElementById('map'),
                        {
                            zoom: 11.5,
                            center: { lat: 25.0360, lng: 121.5640 }
                        }
                    );
                    //Markers
                    for (let i = 0; i < datas.length; i++) {
                        //setTimeout(addNumMarker(datas[i], i + 1), 1000);
                        addNumMarker(datas[i], i + 1);
                    }
                    /*
                    var image_set={
                        "Botega del vin":'<image class="image info" src= "https://www.google.com/maps/uv?hl=zh-TW&pb=!1s0x3442abcf5eec691b:0xafe8d9ff357f12a5!2m22!2m2!1i80!2i80!3m1!2i20!16m16!1b1!2m2!1m1!1e1!2m2!1m1!1e3!2m2!1m1!1e5!2m2!1m1!1e4!2m2!1m1!1e6!3m1!7e115!4shttps://lh5.googleusercontent.com/p/AF1QipPNMImkXBbdKaUgGum61V0nkzPr3_IVCTW3mdYk%3Dw266-h200-k-no!5sBotega+del+vin+-+Google+%E6%90%9C%E5%B0%8B&imagekey=!1e10!2sAF1QipPNMImkXBbdKaUgGum61V0nkzPr3_IVCTW3mdYk&sa=X&ved=2ahUKEwj-uNKY483hAhXEnOAKHUnYB3kQoiowCnoECA0QBg#"></images>',
                        "Cova Taiwan" : '<image class="image info" src = "https://www.petmd.com/sites/default/files/Acute-Dog-Diarrhea-47066074.jpg"></image>',
                        "EL AMOR 西班亞 TAPAS & BAR" : '<image class="image info" src = "https://www.google.com/imgres?imgurl=https%3A%2F%2Fpic.pimg.tw%2Froyalflorence%2F1502881684-2945051746.jpg&imgrefurl=http%3A%2F%2Froyalflorence.pixnet.net%2Fblog%2Fpost%2F400561778-%255B%25E9%25A3%259F%25E8%25A8%2598%255D-%25E5%258F%25B0%25E5%258C%2597%25E5%25A4%25A7%25E5%25AE%2589-%2528%25E7%258F%25BE%25E5%25B7%25B2%25E6%2590%25AC%25E5%2588%25B0%25E4%25B8%25AD%25E5%25B1%25B1%25E5%258D%2580%2529-el-amor-%25E8%25A5%25BF%25E7%258F%25AD&docid=bs8bz9qzVYf7NM&tbnid=1QvNeuP9xvE8fM%3A&vet=10ahUKEwiwre6f783hAhURTt8KHdYaCVUQMwhCKAMwAw..i&w=1000&h=563&bih=722&biw=1536&q=EL%20AMOR%20%E8%A5%BF%E7%8F%AD%E4%BA%9E%20TAPAS%20%26%20BAR&ved=0ahUKEwiwre6f783hAhURTt8KHdYaCVUQMwhCKAMwAw&iact=mrc&uact=8"></image>'
                    }
                    */
                    //map, coords, content, iconImage
                    function addMarker(props) {
                        var marker = new google.maps.Marker({
                            map: map,
                            position: props.coords
                        });
                        if (props.iconImage) {
                            marker.setIcon(props.iconImage);
                        }
                        if (props.content) {
                            var infoWindow = new google.maps.InfoWindow({
                                content: props.content 
                                // + image_set[props.content]
                            });
                            marker.addListener('mouseover', function () {
                                infoWindow.open(map, marker);
                            });
                            marker.addListener('mouseout', function () {
                                infoWindow.close(map, marker);
                            });
                        }
                    }
                    
                    function addNumMarker(props, index) {
                        var geocoder = new google.maps.Geocoder();
                        var geo_base = 'https://maps.googleapis.com/maps/api/geocode/json';
                        var geo_key = 'key=AIzaSyB2hge0DH6QjG-uUuOP48AV1fa45QKBhXY';
                        var address = geo_base + '?address=' + props.address + '&' + geo_key;
                        geocoder.geocode({ 'address': address }, function (results, status) {
                            var data = {
                                coords: results[0].geometry.location,
                                content: props.name,
                                iconImage: 'http://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=' + index + '|FF0000|000000' // hex color of the marker and font
                            }
                            if (status == 'OK') {
                                //map.setZoom(12);
                                addMarker(data);
                            } else if (status == 'OVER_QUERY_LIMIT') {
                                setTimeout(addMarker(data), 2000);
                            }
                            else {
                                var data = {
                                    coords: { lat: 25.0360, lng: 121.5640 },
                                    content: status,
                                    iconImage: 'http://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=' + index + '|FF0000|000000' // hex color of the marker and font
                                }
                                addMarker(data);
                            }
                        });
                    }
                    function sleep(ms) {
                        return new Promise(resolve => setTimeout(resolve, ms));
                    }
                }
            }
        }//end of init()

    </script>
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB2hge0DH6QjG-uUuOP48AV1fa45QKBhXY&callback=init&language=en"></script>
</body>

</html>